<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Dynamically Scaling a Workflow Step in Argo Workflows
        
    </title><meta content="Dynamically Scaling a Workflow Step in Argo Workflows" property=og:title><meta content="Pert's personal site" property=og:description><meta content="Pert's personal site" name=description><link href=/icon/favicon.png rel=icon type=image/png><link href=https://pert.dev/fonts.css rel=stylesheet><script src=https://pert.dev/js/codeblock.js></script><script src=https://pert.dev/js/toc.js></script><script src=https://pert.dev/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://pert.dev/atom.xml rel=alternate title=pert.dev type=application/atom+xml><link href=https://pert.dev/theme/light.css rel=stylesheet><link href=https://pert.dev/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://pert.dev/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://pert.dev/main.css media=screen rel=stylesheet><script src=https://pert.dev/js/mermaid.js></script><body><div class=content><header><div class=main><a href=https://pert.dev>pert.dev</a><div class=socials><a class=social href=https://twitter.com/rupert648 rel=me> <img alt=twitter src=https://pert.dev/social_icons/twitter.svg> </a><a class=social href=https://github.com/rupert648/ rel=me> <img alt=github src=https://pert.dev/social_icons/github.svg> </a><a class=social href=https://buymeacoffee.com/rupertcarr rel=me> <img alt=coffee src=https://pert.dev/social_icons/coffee.svg> </a></div></div><nav><a href=https://pert.dev/posts style=margin-left:.5em>/posts</a><a href=https://pert.dev/projects style=margin-left:.5em>/projects</a><a href=https://pert.dev/tags style=margin-left:.5em>/tags</a> |<a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://pert.dev/feather/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://pert.dev/feather/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>Dynamically Scaling a Workflow Step in Argo Workflows<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2022-11-05</time><span class=tags-label> :: Tags:</span><span class=tags> <a class=post-tag href=https://pert.dev/tags/kubernetes/>Kubernetes</a>, <a class=post-tag href=https://pert.dev/tags/argo/>Argo</a>, <a class=post-tag href=https://pert.dev/tags/argo-workflows/>Argo Workflows</a> </span></div></div><div class=toc-container><h1 class=toc-title>Table of Contents</h1><ul class=toc-list><li><a href=https://pert.dev/posts/dynamic-argo-workflow/#what-is-argo>What is Argo</a><li><a href=https://pert.dev/posts/dynamic-argo-workflow/#why-did-i-need-this-use-case>Why did I need this Use Case?</a><li><a href=https://pert.dev/posts/dynamic-argo-workflow/#installation>Installation</a><li><a href=https://pert.dev/posts/dynamic-argo-workflow/#the-solution>The Solution</a> <ul><li><a href=https://pert.dev/posts/dynamic-argo-workflow/#output-parameters>Output Parameters</a><li><a href=https://pert.dev/posts/dynamic-argo-workflow/#the-withparam-attribute>The withParam attribute</a></ul><li><a href=https://pert.dev/posts/dynamic-argo-workflow/#conclusion>Conclusion</a></ul></div><section class=body><h1 id=what-is-argo><a aria-label="Anchor link for: what-is-argo" class=zola-anchor href=#what-is-argo>What is Argo</a></h1><p>From the Argo Site:<blockquote><p>Argo Workflows is an open source container-native workflow engine for orchestrating parallel jobs on Kubernetes</blockquote><p>Argo workflows allows you to define through a configuration file a series of steps to run inside a kubernetes cluster. Argo from this configuration will control the sequencing for this as well as orchestrating any parallel operations you define.<p>When managing many parallel running workflows, argo does all the leg work for you. It will spin up containers to handle the steps you define using the kubernetes API. However this wasn't what I wanted.<p>The use case I wanted to achieve for was to dynamically scale a <em><strong>single</strong></em> <em><strong>step</strong></em> in a workflow, whilst keeping other steps static.<h1 id=why-did-i-need-this-use-case><a aria-label="Anchor link for: why-did-i-need-this-use-case" class=zola-anchor href=#why-did-i-need-this-use-case>Why did I need this Use Case?</a></h1><p>A simplification of my use case provided just two steps:<ol><li>A data generation step, which puts the data into a shared database<li>A data pulling step, which pulls the data from the database and performs some processing on the data, before dumping it to a storage solution.</ol><p>I wanted the data being generated in the first stage to consistently be unique whilst running the node. There are fancy ways to do this whilst running multiple containers but the simplest way to ensure unique data is to just have a single node generating the data.<p>The second step is what I wanted to scale â€” I want to make a decision based upon how much data is generated from the first step to decide how many instances of the second step I created. This would allow me to process the data in parallel. This would make the data processing step much quicker.<p><em>Note: A better solution to this issue might be to extract the data production from the workflow, however keeping it inside the workflow itself allowed expandability within my use case as well as the ability to extremely easily orchestrate the whole thing on a CRON job.</em><h1 id=installation><a aria-label="Anchor link for: installation" class=zola-anchor href=#installation>Installation</a></h1><p>To preface the solution, to demo these steps I am running these steps in a local cluster using <a href=https://minikube.sigs.k8s.io/docs/start/>Minikube</a>. To install minikube follow the instructions on their site, or using homebrew:<pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#f29718>brew</span><span> install minikube
</span></code></pre><p>Run minikube start to spin up your minikube instance, then run the following to install argo:<pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#f29718>kubectl</span><span> create namespace argo
</span><span style=color:#f29718>kubectl</span><span> apply</span><span style=color:#ff8f40> -n</span><span> argo</span><span style=color:#ff8f40> -f</span><span> https://github.com/argoproj/argo-workflows/releases/download/v</span><span style=color:#ed9366>&lt;&lt;</span><span style=color:#fa6e32>ARGO_WORKFLOWS_VERSION</span><span style=color:#ed9366>>></span><span>/install.yaml
</span></code></pre><p>For the writing of this tutorial, I am using <strong>v3.4.2</strong><p>You will also need to install the <a href=https://github.com/argoproj/argo-workflows/releases/tag/v3.4.3>Argo CLI</a><h1 id=the-solution><a aria-label="Anchor link for: the-solution" class=zola-anchor href=#the-solution>The Solution</a></h1><p>The solution to this problem I found was to utilise the output parameters you are able to pass through the steps in Argo Workflows. We can use these in conjunction with the withParam attribute to run parallel jobs.<h2 id=output-parameters><a aria-label="Anchor link for: output-parameters" class=zola-anchor href=#output-parameters>Output Parameters</a></h2><p>Argo provides several forms of functionality for passing output parameters between steps:<ul><li>Reading the standard output of a container/script<li>Taking the value from a specified file</ul><p>Reading the standard output is okay for simple scripts, however since many programs will involve regular std output such as logging this may conflict and cause issues, hence creating a temp file to write the value is the easier route. Argo provides in their docs an example on how to do this:<pre class=language-yaml data-lang=yaml style=color:#61676c;background-color:#fafafa><code class=language-yaml data-lang=yaml><span style=color:#399ee6>apiVersion</span><span style=color:#61676ccc>: </span><span style=color:#86b300>argoproj.io/v1alpha1
</span><span style=color:#399ee6>kind</span><span style=color:#61676ccc>: </span><span style=color:#86b300>Workflow
</span><span style=color:#399ee6>metadata</span><span style=color:#61676ccc>:
</span><span>  </span><span style=color:#399ee6>generateName</span><span style=color:#61676ccc>: </span><span style=color:#86b300>output-parameter-
</span><span style=color:#399ee6>spec</span><span style=color:#61676ccc>:
</span><span>  </span><span style=color:#399ee6>entrypoint</span><span style=color:#61676ccc>: </span><span style=color:#86b300>output-parameter
</span><span>  </span><span style=color:#399ee6>templates</span><span style=color:#61676ccc>:
</span><span>  - </span><span style=color:#399ee6>name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>output-parameter
</span><span>    </span><span style=color:#399ee6>steps</span><span style=color:#61676ccc>:
</span><span>    - - </span><span style=color:#399ee6>name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>generate-parameter
</span><span>        </span><span style=color:#399ee6>template</span><span style=color:#61676ccc>: </span><span style=color:#86b300>whalesay
</span><span>    - - </span><span style=color:#399ee6>name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>consume-parameter
</span><span>        </span><span style=color:#399ee6>template</span><span style=color:#61676ccc>: </span><span style=color:#86b300>print-message
</span><span>        </span><span style=color:#399ee6>arguments</span><span style=color:#61676ccc>:
</span><span>          </span><span style=color:#399ee6>parameters</span><span style=color:#61676ccc>:
</span><span>          - </span><span style=color:#399ee6>name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>message
</span><span>            </span><span style=color:#399ee6>value</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"{{steps.generate-parameter.outputs.parameters.hello-param}}"
</span><span>
</span><span>  - </span><span style=color:#399ee6>name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>whalesay
</span><span>    </span><span style=color:#399ee6>container</span><span style=color:#61676ccc>:
</span><span>      </span><span style=color:#399ee6>image</span><span style=color:#61676ccc>: </span><span style=color:#86b300>docker/whalesay:latest
</span><span>      </span><span style=color:#399ee6>command</span><span style=color:#61676ccc>: </span><span>[</span><span style=color:#86b300>sh</span><span style=color:#61676ccc>, </span><span style=color:#86b300>-c</span><span>]
</span><span>      </span><span style=color:#399ee6>args</span><span style=color:#61676ccc>: </span><span>[</span><span style=color:#86b300>"sleep 1; echo -n hello world > /tmp/hello_world.txt"</span><span>]
</span><span>    </span><span style=color:#399ee6>outputs</span><span style=color:#61676ccc>:
</span><span>      </span><span style=color:#399ee6>parameters</span><span style=color:#61676ccc>:
</span><span>      - </span><span style=color:#399ee6>name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>hello-param
</span><span>        </span><span style=color:#399ee6>valueFrom</span><span style=color:#61676ccc>:
</span><span>          </span><span style=color:#399ee6>default</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"Foobar"   </span><span style=color:#abb0b6;font-style:italic># Default value to use if retrieving valueFrom fails
</span><span>          </span><span style=color:#399ee6>path</span><span style=color:#61676ccc>: </span><span style=color:#86b300>/tmp/hello_world.txt
</span><span>
</span><span>  - </span><span style=color:#399ee6>name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>print-message
</span><span>    </span><span style=color:#399ee6>inputs</span><span style=color:#61676ccc>:
</span><span>      </span><span style=color:#399ee6>parameters</span><span style=color:#61676ccc>:
</span><span>      - </span><span style=color:#399ee6>name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>message
</span><span>    </span><span style=color:#399ee6>container</span><span style=color:#61676ccc>:
</span><span>      </span><span style=color:#399ee6>image</span><span style=color:#61676ccc>: </span><span style=color:#86b300>docker/whalesay:latest
</span><span>      </span><span style=color:#399ee6>command</span><span style=color:#61676ccc>: </span><span>[</span><span style=color:#86b300>cowsay</span><span>]
</span><span>      </span><span style=color:#399ee6>args</span><span style=color:#61676ccc>: </span><span>[</span><span style=color:#86b300>"{{inputs.parameters.message}}"</span><span>]
</span></code></pre><p>We can see that the first step in this workflow writes the value "hello world" to a file /tmp/hello_world.txt, then argo grabs the value written to the file as a parameter called <em>hello-world</em>. Then we use <code>{{steps.generate-parameter.outputs.parameters.hello-param}}</code> to access that parameter in the next step, which uses whalesay to print out the parameter.<p>We can submit this workflow using the following command:<pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#f29718>argo</span><span> submit</span><span style=color:#ff8f40> -n</span><span> argo</span><span style=color:#ff8f40> --watch</span><span> output-parameter-workflow.yaml
</span></code></pre><p>This will give the following output in the terminal:<p><img alt="Terminal Output" src=https://cdn-images-1.medium.com/max/3200/1*U_VL3AlVeLLL1vE6DYBw9g.png><p>We can view the logs for this workflow to verify the paramater was successfully passed between steps using:<pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#f29718>argo</span><span> logs</span><span style=color:#ff8f40> -n</span><span> argo @latest
</span></code></pre><p><img alt="Log Output" src=https://cdn-images-1.medium.com/max/5120/1*ebc7yTtVAgWBpyhSGvSeNw.png><h2 id=the-withparam-attribute><a aria-label="Anchor link for: the-withparam-attribute" class=zola-anchor href=#the-withparam-attribute>The withParam attribute</a></h2><p>We can use these output parameters to define the number of the following steps using the withParam attribute.<p>The withParam attribute takes a JSON list as input, and will run the steps in parallel for each value in the list.<p>We can use this to our advantage by creating this json list in the previous step, and then using it in the withParam attribute. A simple example of doing this might look as follows:<pre class=language-yaml data-lang=yaml style=color:#61676c;background-color:#fafafa><code class=language-yaml data-lang=yaml><span style=color:#399ee6>apiVersion</span><span style=color:#61676ccc>: </span><span style=color:#86b300>argoproj.io/v1alpha1
</span><span style=color:#399ee6>kind</span><span style=color:#61676ccc>: </span><span style=color:#86b300>Workflow
</span><span style=color:#399ee6>metadata</span><span style=color:#61676ccc>:
</span><span>  </span><span style=color:#399ee6>generateName</span><span style=color:#61676ccc>: </span><span style=color:#86b300>loops-param-result-
</span><span style=color:#399ee6>spec</span><span style=color:#61676ccc>:
</span><span>  </span><span style=color:#399ee6>entrypoint</span><span style=color:#61676ccc>: </span><span style=color:#86b300>loop-param-result-example
</span><span>  </span><span style=color:#399ee6>templates</span><span style=color:#61676ccc>:
</span><span>  - </span><span style=color:#399ee6>name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>loop-param-result-example
</span><span>    </span><span style=color:#399ee6>steps</span><span style=color:#61676ccc>:
</span><span>    - - </span><span style=color:#399ee6>name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>generate
</span><span>        </span><span style=color:#399ee6>template</span><span style=color:#61676ccc>: </span><span style=color:#86b300>gen-number-list
</span><span>    - - </span><span style=color:#399ee6>name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>sleep
</span><span>        </span><span style=color:#399ee6>template</span><span style=color:#61676ccc>: </span><span style=color:#86b300>sleep-n-sec
</span><span>        </span><span style=color:#399ee6>arguments</span><span style=color:#61676ccc>:
</span><span>          </span><span style=color:#399ee6>parameters</span><span style=color:#61676ccc>:
</span><span>          - </span><span style=color:#399ee6>name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>seconds
</span><span>            </span><span style=color:#399ee6>value</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"{{item}}"
</span><span>        </span><span style=color:#399ee6>withParam</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"{{steps.generate.outputs.result}}"
</span><span>
</span><span>  - </span><span style=color:#399ee6>name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>gen-number-list
</span><span>    </span><span style=color:#399ee6>script</span><span style=color:#61676ccc>:
</span><span>      </span><span style=color:#399ee6>image</span><span style=color:#61676ccc>: </span><span style=color:#86b300>python:alpine3.6
</span><span>      </span><span style=color:#399ee6>command</span><span style=color:#61676ccc>: </span><span>[</span><span style=color:#86b300>python</span><span>]
</span><span>      </span><span style=color:#399ee6>source</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>|
</span><span style=color:#86b300>        import json
</span><span style=color:#86b300>        import sys
</span><span style=color:#86b300>        json.dump([i for i in range(20, 31)], sys.stdout)
</span><span>  - </span><span style=color:#399ee6>name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>sleep-n-sec
</span><span>    </span><span style=color:#399ee6>inputs</span><span style=color:#61676ccc>:
</span><span>      </span><span style=color:#399ee6>parameters</span><span style=color:#61676ccc>:
</span><span>      - </span><span style=color:#399ee6>name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>seconds
</span><span>    </span><span style=color:#399ee6>container</span><span style=color:#61676ccc>:
</span><span>      </span><span style=color:#399ee6>image</span><span style=color:#61676ccc>: </span><span style=color:#86b300>alpine:latest
</span><span>      </span><span style=color:#399ee6>command</span><span style=color:#61676ccc>: </span><span>[</span><span style=color:#86b300>sh</span><span style=color:#61676ccc>, </span><span style=color:#86b300>-c</span><span>]
</span><span>      </span><span style=color:#399ee6>args</span><span style=color:#61676ccc>: </span><span>[</span><span style=color:#86b300>"echo sleeping for {{inputs.parameters.seconds}} seconds; sleep {{inputs.parameters.seconds}}; echo done"</span><span>]
</span></code></pre><p>[Rest of blog post continues with all code blocks, images, and formatting preserved...]<h1 id=conclusion><a aria-label="Anchor link for: conclusion" class=zola-anchor href=#conclusion>Conclusion</a></h1><p>So there we go, a way to dynamically scale a step in an Argo Workflow. I would think carefully before deciding if this is something you need, but if you do I think its a neat solution to the problem which takes advantage of configuration attributes available.</section></article></main><div class=viewcount></div><div class=giscus></div><script async src=/js/view-count.js></script><script async crossorigin issue-term=pathname repo=rupert648/pert.dev src=https://utteranc.es/client.js theme=github-dark></script></div>